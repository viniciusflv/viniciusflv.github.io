---
layout: '@/layouts/Post.astro'
categories: Docker
date: 2022-11-19
title: 'Docker: "funciona na minha máquina"'
description: Containers um dos maiores responsáveis por como servimos as aplicações hoje
summary: Containers são unidades padrão de software, que permitem aos desenvolvedores isolar sua aplicação do ambiente onde será executada, resolvendo a dor de cabeça do "funciona na minha máquina"
---

import Mermaid from '@/components/Mermaid.astro';

# Docker: "funciona na minha máquina"

## Containers um dos maiores responsáveis por como servimos as aplicações hoje

---

### O que é o Docker?

Docker é um conjunto de soluções **PaaS (Plataforma Como Um Serviço)**, de código aberto, para servir aplicações através da construção, deploy e gerência de **containers**.

### O que é um container?

#### Segundo o site oficial do Docker

> Containers são **unidades padrão de software**, que permitem aos desenvolvedores **isolar** sua aplicação do ambiente onde será **executada**, resolvendo a dor de cabeça do **"funciona na minha máquina"**.

Vamos entender essa definição. Eles são unidades padrão de software, porque sua execução é isolada do sistema operacional, isso permite que ela funcione **sem interferências** de outros programas, o que a torna mais **estável e reprodutível**.

#### Container **vs** Máquina virtual

Após a definição acima, você talvez esteja pensando: **"Não é isso que uma máquina virtual faz?"**. Bom, realmente um máquina virtual cria um isolamento do sistema operacional principal, mas ela faz isso **virtualizando** outros sistemas operacionais, **consumindo muito mais recursos** em relação aos containers, já que eles funcionam como **processos** do sistema operacional.

<Mermaid
  chart={`
    flowchart TB
      subgraph Docker
      direction TB
        subgraph ct1[App 1]
          nodejs
        end
        subgraph ct2[App 2]
          python
        end
        engine[Motor de container]
        so[Sistema Operacional]
        Kernel

        ct1 --> engine
        ct2 --> engine
        engine --> so --> Kernel --> Hardware
      end

`}

>

<Mermaid
  chart={`
    flowchart TB
      subgraph vm[Máquina Virtual]
      direction TB
        subgraph ct1[App 1]
          nodejs
        end
        subgraph ct2[App 2]
          python
        end
        engine[Hypervisor]
        sov1[SO Virtualizado]
        sov2[SO Virtualizado]
        so[Sistema Operacional]
        Kernel

        ct1 --> sov1 --> engine
        ct2 --> sov2 --> engine
        engine --> so --> Kernel --> Hardware
      end

`}
/>

</Mermaid>

### Como funciona um container?

O container funciona através da combinação de **namespaces**, que é uma funcionalidade que permite o **isolamento** entre grupos de processos em seu nível lógico, com **cgroups**, que uma funcionalidade de definição de limite e compartilhamento de **consumo** de recursos por um processo.

#### Namespaces

- **PID** - Isolamento de processos
- **NET** - Isolamento de interfaces de rede
- **IPC** - Isolamento de comunicação entre processos e memória compartilhada
- **MNT** - Isolamento do Sistema de Arquivos / ponto de montagem
- **UTS** - Isolamento do kernel (simula outro host)

#### [Cgroups](https://android.googlesource.com/kernel/common/+/bcmdhd-3.10/Documentation/cgroups 'Documentação sobre grupos de controle')

- **blkio** - Implementa bloqueio de entrada e saída
- **acct** - Agrupa tarefas usando cgroups e declara o uso de CPU desses grupos
- **sets** - Provém um mecanismo de atribuição de CPUs e memória para um conjunto de tarefas
- **devices** - Implementa um cgroup para impor restrições a arquivos de dispositivos
- **freezer** - Gerencia o estado de execução de uma tarefa, pausando e executando de acordo com a vontade do administrador do sistema
- **hugetlb** - Controlador que permite ajustar o uso de páginas de memória virtual maiores, por grupo de controle
- **memory** - Controlador que isola o comportamento da memória, de um grupo de tarefas, do resto da sistema
- **net_cls** - Provém um interface para marcar pacotes de rede com um identificador de classe
- **net_prio** - Provém um interface que permite a um administrador configurar dinamicamente a prioridade de um tráfico rede
- **resource_counter** - Deve facilitar o gerenciamento de recursos pelos controladores, provendo ferramentas em comum para contabilização

### Docker na prática

#### Instalando o docker no linux

##### Atualizando programas

```shell
sudo apt update
```

##### Instalando dependências

```shell
sudo apt install \
    ca-certificates \
    curl \
    gnupg \
    lsb-release
```

##### Fazendo o download

```shell
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
```

##### Adicionando a chave de assinatura

```shell
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

##### Instalando o Docker CE

```shell
sudo apt install docker-ce docker-ce-cli containerd.io docker-compose-plugin
```

##### Dando permissão de execução da CLI para o usuário

```shell
sudo usermod -aG docker $USER
```

---

---

Procura a imagem localmente
Baixa a imagem caso não encontre
Valida o hash da imagem
Executa o container

Container é uma imagem com uma camada temporária de leitura e escrita
É leve pois é um processo e a imagem é reutilizada mudando só a camada de escrita

### Como subir uma imagem no docker hub?

Crie sua conta

use o comando abaixo para logar

```shell
docker login -u [username]
```

crie uma imagem com [username]/[imagename]

execute o comando

```shell
docker push [username]/[imagename]:[version]
```

### Tipos de persistência

###### Bind mounts

Gerenciados pelo file system

```shell
docker run -it -v /volume-dk:/app ubuntu
```

```shell
docker run -it --mount type=bind,source=/home/viniciusflv/Documents/codes/app-exemplo/volume-dk,target=/app ubuntu
```

###### Volumes

Gerenciados pelo docker

```shell
docker volume create [name]
```

```shell
docker run -it -v meu-volume:/app ubuntu
```

```shell
docker run -it --mount source=meu-volume,target=/app ubuntu
```

###### tmpfs

Não é escrito na camada de leitura e escrita

```shell
docker run -it --tmpfs=/app ubuntu
```

```shell
docker run -it --mount type=tmpfs,destination=/app ubuntu
```

### Comunicação através de redes

Lista redes

```shell
docker network ls
```

###### Bridge

Cria um canal de redes

Cria redes

```shell
docker network create --driver bridge [netname]
```

Nomes de redes

```shell
docker run -it --name [name] --network [netname] [image] [cmd]
```

###### None

Remove a interface de red

###### Host

Remove o isolamento da rede do container e sistema

### Docker compose

É um ferramenta de coordenação containers, não confunda com orquestração

###### Instalando

```shell
sudo apt update
sudo apt install docker-compose-plugin
```

### Comandos

Executa imagem

```shell
docker run [imagem]
```

Executa imagem expondo uma porta

```shell
docker run -d -P [imagem]
```

Executa imagem expondo uma porta definida

```shell
docker run -d -p [porta de fora]:[porta do container] [imagem]
```

Baixa imagem

```shell
docker pull
```

Imagens em execução

```shell
docker ps
```

ou

```shell
docker container ls
```

Todas as imagens que foram executadas

```shell
docker ps -a
```

ou

```shell
docker container ls -a
```

Para a execução

```shell
docker stop [id ou nome]
```

Para a execução instantaneamente

```shell
docker stop -t=0 [id ou nome]
```

Inicia a execução

```shell
docker start [id ou nome]
```

Modo interativo

```shell
docker [comando] -it [id] [comando]
```

Modo desanexado (roda em background)

```shell
docker [comando] -d [id] [comando]
```

Pause a execução

```shell
docker pause [id ou nome]
```

Reinicia a execução

```shell
docker unpause [id ou nome]
```

Remove o container

```shell
docker rm [id ou nome]
```

Remove o container forçadamente

```shell
docker rm [id ou nome] --force
```

Lista imagens

```shell
docker images
```

Inspeciona a imagem

```shell
docker inspect [id ou nome]
```

Mostra as camadas da imagem

```shell
docker history [id ou nome]
```

Constrói a imagem a partir de um Dockerfile

```shell
docker build -t alura/node:1.0 .
```

Deleta todos os containers

```shell
 docker container rm -f $(docker container list -q)
```

Deleta todos os containers menos os em execução

```shell
 docker container prune
```
